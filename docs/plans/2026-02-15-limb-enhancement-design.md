# Limb Enhancement Design — ドット絵ゲームキャラ風の手足改善

**Goal:** 現在の1px棒線の手足を、関節・こぶし・靴底を持つドット絵ゲームキャラ風に改善。100%到達時にはプロシージャル生成された獲得物を持たせる。アニメーションはランダムタイミングで生きた感じを出す。

**Tech Stack:** TypeScript, vitest, 32x32 pixel canvas, ANSI 256 colors, half-block rendering

---

## 1. 手足の形状仕様

### 腕（Arms）

共通ベース形状。パラメータ（`armLength`, `bodyWidthRatio`, `asymmetry`）で太さ・長さ・曲がり角度が変化。

- **上腕**: 2px幅 x `armLength * 0.5` の縦ブロック。肩から下方向
- **肘関節**: 1px横にオフセット（くの字）。パレット色3（明るめ）で表現
- **前腕**: 2px幅 x `armLength * 0.5`。肘から斜め下
- **こぶし（手先）**: 3px幅 x 2px高。パレット色2（本体色）+ パレット色1（アウトライン）

左右対称だが、`asymmetry`パラメータにより肘の曲がり角度が微妙に異なる。

### 脚（Legs）

- **太もも**: 2px幅 x `legLength * 0.5`。胴体下部から下方向
- **膝関節**: パレット色3で1pxハイライト
- **すね**: 2px幅 x `legLength * 0.5`
- **靴底（足先）**: 4px幅 x 2px高。接地感のためすねより1px外側に広がる

左右の脚は `bodyWidth * 0.25` の間隔で配置。

---

## 2. 成長段階（5 Stages）

手足は進行度に応じて5段階で精緻化する。

| Stage | Progress | 腕 | 脚 | 追加 |
|-------|----------|------|------|------|
| 1 | 10〜29% | 1px棒線 | 1px棒線 | — |
| 2 | 30〜49% | 2px幅+肘くの字 | 2px幅+膝ハイライト | — |
| 3 | 50〜69% | +3pxこぶし | +4px靴底 | — |
| 4 | 70〜99% | アウトライン付き完成形 | 明暗差付き靴底 | 曲げポーズ有効化 |
| 5 | 100% | Stage 4 + 獲得物を持つ | Stage 4 | 獲得物表示 |

既存の `adjustForProgress()` の `hasArms`/`hasLegs` ブール値を `limbStage: 1|2|3|4|5` に置き換える。

---

## 3. 獲得物のプロシージャル生成（Stage 5）

100%到達で図鑑登録される際、キャラクターの成長期間を反映した獲得物が付与される。

### 3.1 基本形状ファミリー（5種、seed + traitsから決定）

| ファミリー | シルエット | 配置 |
|-----------|-----------|------|
| **Blade** | 縦長・先端が細い（剣、短剣、針） | 片手で上向きに持つ |
| **Staff** | 縦長・均一幅（杖、棒、旗竿） | 片手で立てて持つ |
| **Shield** | 横広・面積大（盾、本、板） | 片手の前面に構える |
| **Tool** | L字や不規則形（ハンマー、鍵、レンチ） | 片手で下げて持つ |
| **Orb** | 円形・浮遊（球体、歯車、ルーン） | 手の上 or 肩上に浮遊 |

### 3.2 パラメトリック軸（PRNGで決定）

- **length**: 2〜6px（主軸長）
- **width**: 1〜4px（太さ）
- **taper**: 0.0〜1.0（先端のすぼまり度合い）
- **curvature**: 0.0〜1.0（直線 vs 湾曲）
- **crossPiece**: boolean（横棒やガードの有無）

### 3.3 装飾方向性（セッションカテゴリ比率で決定）

カテゴリ比率は形状ファミリーの選択には使わず、装飾のモチーフ方向性にのみ影響する。

- coding偏重 → 直線的・幾何学的な装飾パターン
- debugging偏重 → 円形・レンズ的なモチーフ
- testing偏重 → 堅牢感（太め、角ばった装飾）
- refactoring偏重 → 対称・整った装飾
- docs偏重 → 曲線的・有機的な装飾
- planning偏重 → 放射状のモチーフ
- ops偏重 → 歯車・回転モチーフ
- review偏重 → 左右対称のバランス装飾

### 3.4 豪華さ（トークン消費パターンで3段階）

月間推定トークン量（T0キャリブレーション値）に対する実消費比率で決定。

- **質素**（比率 < 0.5） — アイテムのみ、装飾なし
- **標準**（0.5 〜 1.0） — アイテム+パレット色8の装飾1〜2px
- **豪華**（> 1.0） — アイテム+2色装飾+周囲キラキラ1〜2px

---

## 4. アニメーション

### ランダムタイミング方式

固定サイクル（F0→F1→F2→F3→…）を廃止。ベースフレーム（静止）を基本状態とし、アクションがランダムタイミングで割り込む。

### アクションプール

| アクション | 内容 | 持続 |
|-----------|------|------|
| **blink** | 目を閉じる | 1フレーム |
| **arm_sway** | 片腕を1px上下 | 1〜2フレーム |
| **foot_tap** | 片脚を1px上げる | 1フレーム |
| **gesture** | 耳/尻尾/翼の揺れ（既存） | 1フレーム |
| **shimmer** | 体のハイライト点滅（既存） | 1フレーム |
| **orb_float** | 獲得物(Orb)の上下揺れ | 2フレーム |

### タイミング制御

- 各フレーム更新時（2〜4FPS）に判定
- 発生確率: 約20〜30%（大半はベース静止のまま）
- 発生時、プールからランダムに1つ選択
- 複数アクションの同時発生を許容（腕を上げつつ瞬きなど）
- `limbStage`に応じてプールの候補が増減

### Stage別アニメーション有効範囲

- **Stage 1**: 手足アニメーションなし（blink, gesture, shimmerのみ）
- **Stage 2**: 肘の曲がり角度が微変化
- **Stage 3**: こぶし位置の上下 + 靴底の片足上げ
- **Stage 4**: 全モーション有効
- **Stage 5**: Stage 4 + Orbの浮遊揺れ

### 決定論性の境界

- **決定論的**: 体形、手足形状、獲得物の種類と見た目（seed + traits + progress + カテゴリ比率 + トークン消費）
- **非決定論的**: アニメーションタイミング（時刻ベースPRNG、表示のたびにランダム）

---

## 5. アーキテクチャ変更

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/art/parametric/params.ts` | `hasArms`/`hasLegs` → `limbStage: 1\|2\|3\|4\|5` に変更 |
| `src/art/parametric/progress.ts` | `adjustForProgress`で`limbStage`を進行度から計算 |
| `src/art/parametric/features.ts` | 手足の描画ロジックを全面改修。Stage別の形状生成 |
| `src/art/parametric/types.ts` | `CreatureParams`に`limbStage`追加、`hasArms`/`hasLegs`削除 |
| `src/art/animator.ts` | 固定4フレーム → ベースフレーム + アクションプール方式 |
| `src/art/renderer.ts` | アニメーション生成の呼び出し変更 |
| **新規** `src/art/parametric/item.ts` | 獲得物のプロシージャル生成エントリ |
| **新規** `src/art/parametric/item-shapes.ts` | 5ファミリーの形状生成関数 |

### データフロー

```
既存:
  CreatureParams → silhouette → rasterize → features → pattern → 固定4フレーム

改修後:
  CreatureParams(+limbStage)
    → silhouette → rasterize → features(Stage別) → pattern
    → item生成(Stage5のみ)
    → ベースフレーム生成
    → UI層でランダムアクション動的適用
```

### コレクション再レンダリング

`collection.json`のペットは`seed` + `traits` + `progress(=1.0)` + `sessionStats`から常に再生成。保存済みの`frames`フィールドは参考データ扱い。保存構造の変更不要。

---

## 6. テスト戦略

### ユニットテスト

| テスト対象 | 検証内容 |
|-----------|---------|
| `limbStage`計算 | progress 0〜100%の各閾値で正しいStageが返る |
| Stage別手足描画 | 各Stageでピクセルキャンバス上の手足ピクセル数・幅・位置が期待通り |
| 関節オフセット | Stage2以上で肘のくの字が1pxオフセット |
| こぶし/靴底 | Stage3以上で末端ピクセルが正しいサイズ・パレット色 |
| 獲得物生成 | 5ファミリーそれぞれのシルエットが期待のサイズ範囲内 |
| 獲得物パラメータ | seed変更でlength/width/taper等が変化する |
| 豪華さ判定 | トークン比率の3段階閾値が正しく動作 |
| 装飾方向性 | カテゴリ比率によるモチーフ選択が正しい |

### インテグレーションテスト

| テスト対象 | 検証内容 |
|-----------|---------|
| パイプライン結合 | seed+traits+progress→完全なフレーム生成が例外なく完了 |
| Stage遷移 | progress 0%→100%まで段階的にフレーム生成し各Stageの特徴出現 |
| コレクション再レンダリング | 保存済みペットデータから再生成したフレームが妥当 |

### アニメーションテスト

| テスト対象 | 検証内容 |
|-----------|---------|
| アクション適用 | 各アクション関数がベースフレームに正しく差分適用 |
| Stage別プール | limbStageに応じて利用可能アクション数が正しい |
| フレーム類似度 | アクション適用後もベースと95%以上のピクセル一致 |
